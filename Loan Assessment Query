CREATE OR ALTER PROCEDURE LoanAssess(@district_name VARCHAR(50), @account_id INT, @salary INT)
AS 
BEGIN;
DECLARE @points INT = 0;
DECLARE @hist VARCHAR(50);

IF EXISTS (SELECT pct_of_loans_bad
		FROM pct_bad_loans_by_dist
		WHERE @district_name = district_name
		AND pct_of_loans_bad = 0)
	BEGIN 
	SET @points = @points + 5;
	END;
ELSE IF EXISTS (SELECT *-- pct_of_loans_bad
				FROM pct_bad_loans_by_dist
				WHERE @district_name = district_name
				AND pct_of_loans_bad BETWEEN 0 AND 15)
	BEGIN 
	SET @points = @points + 2;
	END;
ELSE IF EXISTS (SELECT pct_of_loans_bad
				FROM pct_bad_loans_by_dist
				WHERE @district_name = district_name
				AND pct_of_loans_bad > 20)
	BEGIN 
	SET @points = @points -5;
	END

-- Allocates points based on pct of loans previously defaulted in your district

IF EXISTS (SELECT *
			FROM loan
			WHERE @account_id = account_id
			AND status = 'A')
	BEGIN;
	SET @points = @points + 5
	SET @hist = 'Previous Loan Repaid'
	END;
ELSE IF EXISTS (SELECT *
			FROM loan
			WHERE @account_id = account_id
			AND status = 'B')
	BEGIN;
	SET @points = @points - 100;
	SET @hist ='Previous Loan Defaulted-Blacklist';
	END;
ELSE IF EXISTS (SELECT *
			FROM loan
			WHERE @account_id = account_id
			AND status IN ('C', 'D'))
	BEGIN;
	SET @hist ='Already Have a Loan With Us';
	END;
ELSE 
	BEGIN;
	SET @hist = 'Never Had A Loan With Us';
	END;
-- Checks status of any other loans they have/ have had

IF @salary > 1.3*(SELECT *	FROM national_avg_salary)
		BEGIN;
		SET @points = @points + 10
		END;
IF @salary BETWEEN 1.1*(SELECT * FROM national_avg_salary) AND 1.25 (SELECT * FROM national_avg_salary)
		BEGIN;
		SET @points = @points + 5
		END;
IF 0.9*(SELECT * FROM national_avg_salary) <= @salary 
	AND @salary < 1.1(SELECT * FROM national_avg_salary)
		BEGIN;
		SET @points = @points 
		END;
IF @salary < 0.9*(SELECT *	FROM national_avg_salary)
		BEGIN;
		SET @points = @points - 5
		END;

--Compares their salary to the national average salary

IF @points <-10 
	PRINT 'Blacklist';
ELSE IF (-10 <= @points AND @points <0)
    PRINT 'High Risk!';  
ELSE  IF (0 <= @points AND @points < 10)
    PRINT 'Medium Risk.';  
ELSE 
	PRINT 'Low Risk :)';
PRINT @hist
END;
